┌─────────────────────────────────────────────────────────────────────────────┐
│                  SOLANA USDC TOKEN TRANSFER FIX - FLOW DIAGRAM              │
└─────────────────────────────────────────────────────────────────────────────┘

BEFORE FIX (BROKEN):
═══════════════════
User clicks QR → handleCryptoQRSelection() → ALWAYS uses morphPaymentService
                                              ↓
                                        EIP-681 URI (Ethereum)
                                              ↓
                                        ❌ WRONG: Phantom shows "12 SOL"

AFTER FIX (WORKING):
═══════════════════

┌────────────────────────────────────────────────────────────────────────────┐
│ 1. USER ACTION: Click "Crypto QR" on Payment Cube                         │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 2. FETCH AGENT DATA                                                        │
│    - wallet_address: Dn382aRJfXJwyE12Yck3mLSXtGeMQdcSJ7NR5wsQaJd5        │
│    - token_address: 4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU (NEW!)  │
│    - chain_type: SVM (NEW!)                                                │
│    - interaction_fee: 12                                                   │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 3. BLOCKCHAIN DETECTION (NEW!)                                             │
│                                                                             │
│    Chain Type Check:                                                       │
│    ├─ chainType === "SVM"? → YES ✓                                        │
│    └─ Is Solana agent? → YES                                              │
│                                                                             │
│    Address Format Check (Fallback):                                       │
│    ├─ Starts with "0x"? → NO                                              │
│    ├─ Length 32-44 chars? → YES                                           │
│    ├─ Valid Base58? → YES                                                 │
│    └─ Is Solana address? → YES                                            │
│                                                                             │
│    DECISION: Use SOLANA payment service ✓                                  │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 4. ROUTE TO APPROPRIATE SERVICE                                            │
│                                                                             │
│    if (isSolana) {                                                         │
│      ┌──────────────────────────────────────────────────────────────┐     │
│      │ SOLANA PAYMENT SERVICE                                       │     │
│      │                                                               │     │
│      │ Network Selection:                                           │     │
│      │ ├─ Has token_address? → YES                                 │     │
│      │ ├─ Is USDC Devnet address? → YES                            │     │
│      │ └─ Use network: DEVNET ✓                                    │     │
│      │                                                               │     │
│      │ Payment Info:                                                │     │
│      │ ├─ recipient: Dn382aRJ...                                   │     │
│      │ ├─ amount: 12                                               │     │
│      │ ├─ tokenMint: 4zMMC9... (SPL token address) ✓              │     │
│      │ └─ network: DEVNET                                          │     │
│      │                                                               │     │
│      │ generateSolanaPaymentQRData(paymentInfo)                    │     │
│      └──────────────────────────────────────────────────────────────┘     │
│    } else {                                                                │
│      ┌──────────────────────────────────────────────────────────────┐     │
│      │ MORPH PAYMENT SERVICE (EVM)                                  │     │
│      │ - Uses EIP-681 format                                        │     │
│      │ - For Ethereum, Polygon, etc.                                │     │
│      └──────────────────────────────────────────────────────────────┘     │
│    }                                                                       │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 5. GENERATE SOLANA PAY URI (solanaPaymentService.js)                      │
│                                                                             │
│    Base URI: solana:{recipient}                                           │
│              solana:Dn382aRJfXJwyE12Yck3mLSXtGeMQdcSJ7NR5wsQaJd5         │
│                                                                             │
│    Add SPL Token Parameter (THE KEY FIX!):                                │
│    ├─ Has tokenMint? → YES                                                │
│    └─ Add: ?spl-token=4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU       │
│                                                                             │
│    Add Amount:                                                             │
│    └─ Add: &amount=12.000000                                              │
│                                                                             │
│    Add Label:                                                              │
│    └─ Add: &label=AR Agent USDC Payment                                   │
│                                                                             │
│    FINAL URI:                                                              │
│    solana:Dn382aRJfXJwyE12Yck3mLSXtGeMQdcSJ7NR5wsQaJd5?                   │
│           spl-token=4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU&         │
│           amount=12.000000&                                                │
│           label=AR Agent USDC Payment                                      │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 6. DISPLAY QR CODE                                                         │
│    <QRCode value={qrPaymentData} />                                       │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 7. USER SCANS QR WITH PHANTOM WALLET                                       │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 8. PHANTOM WALLET PARSING                                                  │
│                                                                             │
│    Parse URI: solana:Dn382aRJ...?spl-token=4zMMC9...&amount=12...        │
│                                                                             │
│    Extract Parameters:                                                     │
│    ├─ Protocol: solana                                                    │
│    ├─ Recipient: Dn382aRJfXJwyE12Yck3mLSXtGeMQdcSJ7NR5wsQaJd5           │
│    ├─ SPL Token: 4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU (FOUND!) │
│    └─ Amount: 12                                                          │
│                                                                             │
│    Token Lookup:                                                           │
│    ├─ Query token metadata for 4zMMC9...                                 │
│    └─ Result: USDC (6 decimals)                                          │
└────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌────────────────────────────────────────────────────────────────────────────┐
│ 9. PHANTOM WALLET DISPLAY                                                  │
│                                                                             │
│    ┌──────────────────────────────────────────────────┐                   │
│    │  👻 Phantom Wallet                               │                   │
│    │                                                   │                   │
│    │  Transfer USDC ✅ (not "Transfer SOL")          │                   │
│    │                                                   │                   │
│    │  Amount: 12 USDC ✅                              │                   │
│    │  To: Dn382aRJ...                                 │                   │
│    │  Network: Solana Devnet ✅                       │                   │
│    │  Token: 4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJ... │                   │
│    │                                                   │                   │
│    │  [ Approve ] [ Reject ]                          │                   │
│    └──────────────────────────────────────────────────┘                   │
└────────────────────────────────────────────────────────────────────────────┘

KEY DIFFERENCES:
═══════════════

BEFORE:                          AFTER:
├─ No token_address             ├─ Fetches token_address from DB ✓
├─ No blockchain detection      ├─ Detects Solana vs EVM ✓
├─ Always uses Morph service    ├─ Routes to correct service ✓
├─ No spl-token parameter       ├─ Includes spl-token in URI ✓
└─ Phantom shows "12 SOL" ❌    └─ Phantom shows "12 USDC" ✅

FILES MODIFIED:
══════════════
├─ src/components/CubePaymentEngine.jsx
│  ├─ getAgentPaymentConfig() - Added chain_id, token_address, chain_type
│  └─ handleCryptoQRSelection() - Added blockchain detection & routing

FILES LEVERAGED (UNCHANGED):
════════════════════════════
├─ src/services/solanaPaymentService.js - Already had SPL token support
├─ src/services/paymentProcessor.js - Already parsed spl-token parameter
└─ src/services/morphPaymentService.js - Continues to handle EVM payments
